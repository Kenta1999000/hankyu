<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <title>é˜ªæ€¥ãƒ«ãƒ¼ãƒˆæ¤œç´¢ (LIFF)</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- SortableJSï¼ˆãƒ‰ãƒ©ãƒƒã‚°ä¸¦ã³æ›¿ãˆç”¨ï¼‰ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            --hankyu-maroon: #73212B;
            --hankyu-gold: #C9A66B;
            --bg-light: #F9F5F2;
        }

        body {
            font-family: "Helvetica Neue", "Hiragino Sans", "Noto Sans JP", sans-serif;
            background: linear-gradient(180deg, #faf7f5 0%, #f3efed 100%);
            padding: 16px;
            color: #333;
        }

        h2 {
            background: var(--hankyu-maroon);
            color: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            font-size: 20px;
            font-weight: 600;
            letter-spacing: 1px;
            margin-bottom: 20px;
        }

        .card {
            background: #fff;
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 18px;
            border: 2px solid var(--hankyu-gold);
        }

        label {
            font-weight: 600;
            margin-top: 14px;
            display: block;
            color: var(--hankyu-maroon);
        }

        select {
            width: 100%;
            padding: 12px;
            margin-top: 6px;
            border-radius: 8px;
            border: 1.5px solid #ccc;
            background: #fff;
            font-size: 15px;
        }

        button {
            width: 100%;
            padding: 14px;
            margin-top: 14px;
            border-radius: 6px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            color: #fff;
            background: var(--hankyu-maroon);
            transition: 0.2s;
        }
        button:hover {
            background: #8d2c38;
        }

        .stop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-light);
            border: 1.5px solid var(--hankyu-gold);
            border-radius: 8px;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--hankyu-maroon);
        }

        .delete-stop {
            background: #cc3333;
            border: none;
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 6px;
            font-size: 16px;
        }

        .delete-stop:active { background: #a00000; }

        #result {
            border-left: 4px solid var(--hankyu-maroon);
            padding-left: 10px;
            margin-top: 18px;
        }

        .line-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        .line-select-wrapper {
            flex: 1 1 auto;
        }
        .line-tag {
            flex: 0 0 auto;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            color: #fff;
            white-space: nowrap;
        }
    </style>
</head>

<body>

<h2>é˜ªæ€¥ãƒ«ãƒ¼ãƒˆæ¤œç´¢ï¼ˆè·¯ç·šåˆ¥é¸æŠãƒ»é˜ªæ€¥ãƒãƒ«ãƒ¼ãƒ³ç‰ˆï¼‰</h2>

<div class="card">

    <!-- å‡ºç™ºé§…ï¼šè·¯ç·š â†’ é§… -->
    <label>å‡ºç™ºã™ã‚‹è·¯ç·šï¼š</label>
    <div class="line-row">
        <div class="line-select-wrapper">
            <select id="startLine" onchange="updateStartStations()"></select>
        </div>
        <span id="startLineTag" class="line-tag"></span>
    </div>

    <label>å‡ºç™ºé§…ï¼š</label>
    <select id="startStation"></select>

    <!-- é€”ä¸­ä¸‹è»Šï¼šè·¯ç·š â†’ é§…å€™è£œ â†’ ä¸¦ã³æ›¿ãˆ -->
    <label>é€”ä¸­ä¸‹è»Šã™ã‚‹è·¯ç·šï¼š</label>
    <div class="line-row">
        <div class="line-select-wrapper">
            <select id="stopLine" onchange="updateStopStations()"></select>
        </div>
        <span id="stopLineTag" class="line-tag"></span>
    </div>

    <label>é€”ä¸­ä¸‹è»Šå€™è£œï¼š</label>
    <select id="stopCandidates" multiple size="6"></select>
    <button onclick="addStops()">é¸æŠã—ãŸé§…ã‚’é€”ä¸­ä¸‹è»Šãƒªã‚¹ãƒˆã«è¿½åŠ </button>

    <label>é€”ä¸­ä¸‹è»Šï¼ˆãƒ‰ãƒ©ãƒƒã‚°ã§é †ç•ªå¤‰æ›´ï¼‰ï¼š</label>
    <div id="sortableStops" style="min-height:60px; padding:10px; background:#fafafa; border-radius:8px;"></div>

    <!-- åˆ°ç€é§…ï¼šè·¯ç·š â†’ é§… -->
    <label>åˆ°ç€ã™ã‚‹è·¯ç·šï¼š</label>
    <div class="line-row">
        <div class="line-select-wrapper">
            <select id="goalLine" onchange="updateGoalStations()"></select>
        </div>
        <span id="goalLineTag" class="line-tag"></span>
    </div>

    <label>åˆ°ç€é§…ï¼š</label>
    <select id="goalStation"></select>

    <button onclick="calculateRoute()">æ¤œç´¢ã™ã‚‹</button>
    <button id="sendMessageBtn" style="display:none; background:#1E90FF;">çµæœã‚’LINEã«é€ä¿¡</button>
</div>

<div id="result" class="card" style="display:none;"></div>

<script>
    const ONE_DAY_PASS = 1300;
    let lastResultText = "";
    let lastData = null;
    let lastRecommendation = "";

    const LINES = {
        "ç¥æˆ¸æœ¬ç·š": ["å¤§é˜ªæ¢…ç”°","ä¸­æ´¥","åä¸‰","ç¥å´å·","åœ’ç”°","å¡šå£","æ­¦åº«ä¹‹è˜","è¥¿å®®åŒ—å£","å¤™å·","èŠ¦å±‹å·","å²¡æœ¬","å¾¡å½±","å…­ç”²","ç‹å­å…¬åœ’","æ˜¥æ—¥é‡é“","ç¥æˆ¸ä¸‰å®®"],
        "å®å¡šæœ¬ç·š": ["å¤§é˜ªæ¢…ç”°","ä¸­æ´¥","åä¸‰","ä¸‰å›½","åº„å†…","æœéƒ¨å¤©ç¥","æ›½æ ¹","å²¡ç”º","è±Šä¸­","è›æ± ","çŸ³æ©‹é˜ªå¤§å‰","æ± ç”°","å·è¥¿èƒ½å‹¢å£","é›²é›€ä¸˜èŠ±å±‹æ•·","å±±æœ¬","ä¸­å±±è¦³éŸ³","å£²å¸ƒç¥ç¤¾","æ¸…è’ç¥","å®å¡š"],
        "äº¬éƒ½æœ¬ç·š": ["å¤§é˜ªæ¢…ç”°","ä¸­æ´¥","åä¸‰","å—æ–¹","å´‡ç¦…å¯º","æ·¡è·¯","ä¸Šæ–°åº„","ç›¸å·","æ­£é›€","æ‘‚æ´¥å¸‚","å—èŒ¨æœ¨","èŒ¨æœ¨å¸‚","ç·æŒå¯º","å¯Œç”°","é«˜æ§»å¸‚","ä¸Šç‰§","æ°´ç„¡ç€¬","å¤§å±±å´","é•·å²¡å¤©ç¥","è¥¿å±±å¤©ç‹å±±","æ¡‚","è¥¿äº¬æ¥µ","è¥¿é™¢","å¤§å®®","çƒä¸¸","äº¬éƒ½æ²³åŸç”º"],
        "åƒé‡Œç·š": ["å¤©ç¥æ©‹ç­‹å…­ä¸ç›®","æŸ´å³¶","æ·¡è·¯","ä¸‹æ–°åº„","å¹ç”°","è±Šæ´¥","æ±Ÿå‚","å—åƒé‡Œ","åƒé‡Œå±±","é–¢å¤§å‰","åŒ—åƒé‡Œ"],
        "ç®•é¢ç·š": ["çŸ³æ©‹é˜ªå¤§å‰","æ¡œäº•","ç‰§è½","ç®•é¢"],
        "ä»Šæ´¥ç·š": ["å®å¡š","å®å¡šå—å£","é€†ç€¬å·","å°æ—","ä»å·","ç”²æ±åœ’","é–€æˆ¸å„ç¥","è¥¿å®®åŒ—å£","é˜ªç¥å›½é“","ä»Šæ´¥"],
        "ä¼Šä¸¹ç·š": ["å¡šå£","ç¨²é‡","æ–°ä¼Šä¸¹","ä¼Šä¸¹"],
        "ç”²é™½ç·š": ["è¥¿å®®åŒ—å£","è‹¦æ¥½åœ’å£","ç”²é™½åœ’"],
        "åµå±±ç·š": ["æ¡‚","ä¸Šæ¡‚","æ¾å°¾å¤§ç¤¾","åµå±±"]
    };

    const LINE_COLORS = {
        "ç¥æˆ¸æœ¬ç·š": "#73212B",
        "å®å¡šæœ¬ç·š": "#2C9C6F",
        "äº¬éƒ½æœ¬ç·š": "#D7443F",
        "åƒé‡Œç·š": "#2563EB",
        "ç®•é¢ç·š": "#E0A800",
        "ä»Šæ´¥ç·š": "#7C3AED",
        "ä¼Šä¸¹ç·š": "#A16207",
        "ç”²é™½ç·š": "#DB2777",
        "åµå±±ç·š": "#15803D"
    };

    async function initLIFF() {
        await liff.init({ liffId: "2008501171-EPnG284V" });
    }

    function setupSortable() {
        Sortable.create(document.getElementById("sortableStops"), { animation: 150 });
    }

    function initLineSelectors() {
        const lines = Object.keys(LINES);

        lines.forEach(line => {
            startLine.add(new Option(line, line));
            stopLine.add(new Option(line, line));
            goalLine.add(new Option(line, line));
        });

        updateStartStations();
        updateStopStations();
        updateGoalStations();
    }

    function updateStartStations() {
        const line = startLine.value;
        startStation.innerHTML = "";
        LINES[line].forEach(st => startStation.add(new Option(st, st)));
        startLineTag.textContent = line;
        startLineTag.style.backgroundColor = LINE_COLORS[line];
    }

    function updateStopStations() {
        const line = stopLine.value;
        stopCandidates.innerHTML = "";
        LINES[line].forEach(st => stopCandidates.add(new Option(st, st)));
        stopLineTag.textContent = line;
        stopLineTag.style.backgroundColor = LINE_COLORS[line];
    }

    function updateGoalStations() {
        const line = goalLine.value;
        goalStation.innerHTML = "";
        LINES[line].forEach(st => goalStation.add(new Option(st, st)));
        goalLineTag.textContent = line;
        goalLineTag.style.backgroundColor = LINE_COLORS[line];
    }

    function addStops() {
        const selected = Array.from(stopCandidates.selectedOptions).map(o => o.value);
        selected.forEach(st => {
            const div = document.createElement("div");
            div.className = "stop-item";
            div.dataset.station = st;
            div.innerHTML = `
                <span>${st}</span>
                <button class="delete-stop" onclick="removeStop(this)">Ã—</button>
            `;
            sortableStops.appendChild(div);
        });
    }

    function removeStop(btn) {
        btn.parentElement.remove();
    }

    async function calculateRoute() {
        const BASE = window.location.origin;

        const start = startStation.value;
        const goal  = goalStation.value;

        const stops = Array.from(document.querySelectorAll("#sortableStops .stop-item"))
                           .map(div => div.dataset.station);

        const url = `${BASE}/hankyu/calc?start=${encodeURIComponent(start)}&goal=${encodeURIComponent(goal)}&stops=${encodeURIComponent(stops.join(","))}`;
        const data = await fetch(url).then(r => r.json());

        result.style.display = "block";

        if (data.error) {
            result.innerHTML = `<b>ã‚¨ãƒ©ãƒ¼ï¼š</b> ${data.error}`;
            return;
        }

        let recommendation;
        if (data.total_fare < ONE_DAY_PASS) {
            recommendation = "é€šå¸¸é‹è³ƒã®æ–¹ãŒå®‰ã„ã§ã™";
        } else if (data.total_fare > ONE_DAY_PASS) {
            recommendation = "1æ—¥ä¹—è»Šåˆ¸ã®æ–¹ãŒå®‰ã„ã§ã™";
        } else {
            recommendation = "ã©ã¡ã‚‰ã‚‚åŒã˜é‡‘é¡ã§ã™";
        }

        // ãƒ–ãƒ©ã‚¦ã‚¶å†…ã®è¡¨ç¤º
        let html = `<h3>æ¤œç´¢çµæœ</h3>`;
        html += `<p><b>æ—…ç¨‹ï¼š</b> ${data.journey_order.join(" â†’ ")}</p>`;
        html += `<p><b>åˆè¨ˆé‹è³ƒï¼š</b> ${data.total_fare}å††</p>`;
        html += `<p><b>1æ—¥ä¹—è»Šåˆ¸ï¼š</b> ${ONE_DAY_PASS}å††</p>`;
        html += `<p><b>ãŠã™ã™ã‚ï¼š</b> ${recommendation}</p>`;

        html += `<h4>åŒºé–“è©³ç´°</h4>`;
        data.details.forEach(d => {
            html += `
                <div style="margin-bottom:10px; border-left:3px solid var(--hankyu-maroon); padding-left:8px;">
                    <b style="color:var(--hankyu-maroon);">${d.start} â†’ ${d.goal}</b><br>
                    è·é›¢ï¼š${d.distance_km} km<br>
                    é‹è³ƒï¼š${d.fare}å††
                </div>
            `;
        });

        result.innerHTML = html;

        // ãƒ†ã‚­ã‚¹ãƒˆç‰ˆï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ï¼‰
        lastResultText = `ã€é˜ªæ€¥ãƒ«ãƒ¼ãƒˆæ¤œç´¢ã€‘

æ—…ç¨‹ï¼š
${data.journey_order.join(" â†’ ")}

åˆè¨ˆé‹è³ƒï¼š${data.total_fare}å††
1æ—¥ä¹—è»Šåˆ¸ï¼š${ONE_DAY_PASS}å††
ãŠã™ã™ã‚ï¼š${recommendation}
`;

        // Flexç”¨ã«ä¿æŒ
        lastData = data;
        lastRecommendation = recommendation;

        sendMessageBtn.style.display = "block";
    }

    // Flex Message é€ä¿¡
    function sendFlexMessage(data, recommendation) {
        if (!data) {
            alert("å…ˆã«ãƒ«ãƒ¼ãƒˆæ¤œç´¢ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        const detailContents = data.details.map(d => ({
            type: "text",
            text: `${d.start} â†’ ${d.goal}ï¼ˆ${d.distance_km}km / ${d.fare}å††ï¼‰`,
            size: "sm",
            wrap: true
        }));

        const bubble = {
            type: "bubble",
            size: "mega",
            body: {
                type: "box",
                layout: "vertical",
                spacing: "md",
                contents: [
                    {
                        type: "text",
                        text: "ğŸšƒ é˜ªæ€¥ãƒ«ãƒ¼ãƒˆæ¤œç´¢ çµæœ",
                        weight: "bold",
                        size: "lg",
                        color: "#73212B"
                    },
                    {
                        type: "box",
                        layout: "vertical",
                        spacing: "sm",
                        contents: [
                            {
                                type: "text",
                                text: `æ—…ç¨‹ï¼š${data.journey_order.join(" â†’ ")}`,
                                wrap: true
                            },
                            {
                                type: "text",
                                text: `åˆè¨ˆé‹è³ƒï¼š${data.total_fare}å††`,
                                weight: "bold",
                                color: "#73212B"
                            },
                            {
                                type: "text",
                                text: `1æ—¥ä¹—è»Šåˆ¸ï¼š${ONE_DAY_PASS}å††`,
                                weight: "bold",
                                color: "#73212B"
                            },
                            {
                                type: "text",
                                text: `ãŠã™ã™ã‚ï¼š${recommendation}`,
                                weight: "bold",
                                color: "#C9A66B",
                                wrap: true
                            }
                        ]
                    },
                    {
                        type: "separator",
                        color: "#C9A66B"
                    },
                    {
                        type: "text",
                        text: "åŒºé–“è©³ç´°",
                        weight: "bold",
                        size: "md",
                        margin: "md",
                        color: "#73212B"
                    },
                    {
                        type: "box",
                        layout: "vertical",
                        spacing: "xs",
                        margin: "sm",
                        contents: detailContents
                    }
                ]
            }
        };

        liff.sendMessages([
            {
                type: "flex",
                altText: "é˜ªæ€¥ãƒ«ãƒ¼ãƒˆæ¤œç´¢çµæœ",
                contents: bubble
            }
        ]).then(() => {
            alert("Flex Message ã‚’ LINE ã«é€ä¿¡ã—ã¾ã—ãŸï¼");
        }).catch(err => {
            console.error(err);
            alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        });
    }

    sendMessageBtn.onclick = () => {
        // Flex ã‚’é€ã‚‹ï¼ˆå¿…è¦ãªã‚‰ lastResultText ã§ texté€ä¿¡ã‚‚ fallback ã«ã§ãã‚‹ï¼‰
        sendFlexMessage(lastData, lastRecommendation);
    };

    (async () => {
        await initLIFF();
        initLineSelectors();
        setupSortable();
    })();
</script>

</body>
</html>
